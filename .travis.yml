language: java

# we test at Ubuntu Trusty (Ubuntu 14.04 LTS)
# see https://docs.travis-ci.com/user/trusty-ci-environment/
# This environment is continuously updated as described in https://docs.travis-ci.com/user/build-environment-updates/
dist: trusty
sudo: required

services:
  - postgresql
  - mysql

env:
  global:
    - GRADLE_OPTS=-Dorg.gradle.daemon=false
  matrix:
    - TEST_SUITE=check OPTIONS=modernizer
    - TEST_SUITE=fetcherTest
    - TEST_SUITE=databaseTest

# JavaFX localization tests need a running X environment
before_install:
  - "export DISPLAY=:99.0"
  - "sh -e /etc/init.d/xvfb start"
  - sleep 3 # give xvfb some time to start

install: true

before_script:
  - psql -c 'create database jabref;' -U postgres
  - mysql -u root -e 'create database jabref'

script:
  - if [ "$TEST_SUITE" != "guiTest" ]; ./gradlew $TEST_SUITE $OPTIONS -Dscan
  # no need for databases for the integrationTest -> save memory
  # currently does not work: "stop: Unknown instance:" - sudo service mysql stop
  - if [ "$TEST_SUITE" == "guiTest" ]; sudo service postgresql stop
  # following services identified by "sudo service --status-all" do not need to run, too
  # excluded: rsyslog (feels wrong), udev (feels wrong), friendly-recovery ("Unknown instance" error)
  - if [ "$TEST_SUITE" == "guiTest" ]; sudo service acpid stop
  - if [ "$TEST_SUITE" == "guiTest" ]; sudo service atd stop
  - if [ "$TEST_SUITE" == "guiTest" ]; sudo service cron stop
  - if [ "$TEST_SUITE" == "guiTest" ]; sudo service memcached stop
  - if [ "$TEST_SUITE" == "guiTest" ]; sudo service ntp stop
  - if [ "$TEST_SUITE" == "guiTest" ]; sudo service rabbitmq-server stop
  - if [ "$TEST_SUITE" == "guiTest" ]; sudo service resolvconf stop
  - if [ "$TEST_SUITE" == "guiTest" ]; sudo service sshguard stop
  - if [ "$TEST_SUITE" == "guiTest" ]; sudo service ssh stop
  # Integration tests run in a timeout. Just start them and kill them after 60s.
  - if [ "$TEST_SUITE" == "guiTest" ]; timeout 60 ./gradlew guiTest -Dscan --info || true

after_script:
  # enable codecov report
  - ./gradlew jacocoTestReport
  - bash <(curl -s https://codecov.io/bash)

after_failure:
  # show test results if build fails
  - $TRAVIS_BUILD_DIR/scripts/after-failure.sh

# cache gradle dependencies
# https://docs.travis-ci.com/user/languages/java#Caching
before_cache:
  - rm -f $HOME/.gradle/caches/modules-2/modules-2.lock
cache:
  directories:
  - $HOME/.gradle/caches/
  - $HOME/.gradle/wrapper/
