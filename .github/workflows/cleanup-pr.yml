name: Cleanup after PR

on:
  pull_request:
    types: [closed]

jobs:
  cleanup:
    runs-on: ubuntu-latest
    if: github.repository_owner == 'JabRef'
    steps:
      - name: Cancel deployment run
        uses: styfle/cancel-workflow-action@0.12.1
        with:
          ignore_sha: true
          workflow_id: 9813 # workflow "Deployment"
      - name: Delete folder on builds.jabref.org
        uses: appleboy/ssh-action@v1.1.0
        with:
          script: rm -rf /var/www/builds.jabref.org/www/pull/${{ github.event.pull_request.number }} || true
          host: build-upload.jabref.org
          port: 9922
          username: jrrsync
          key: ${{ secrets.buildJabRefPrivateKey }}
      - name: Update PR comment
        uses: thollander/actions-comment-pull-request@v3
        with:
          comment-tag: download-link
          message: The build for this PR is no longer available. Please visit <https://builds.jabref.org/main/> for the latest build.
          mode: upsert
