name: On PR closed

on:
  pull_request_target:
    types: [ closed ]

jobs:
  unassign_issue:
    name: Mark issue as available
    runs-on: ubuntu-latest
    if: github.event.action == 'closed' && !github.event.pull_request.merged && github.actor != 'dependabot[bot]'
    permissions:
      contents: read
      issues: write
    steps:
      - name: echo PR data
        run: |
          echo "PR Number: ${{ github.event.pull_request.number }}"
          echo "PR URL: ${{ github.event.pull_request.html_url }}"
          echo "PR Body"
          echo "${{ github.event.pull_request.body }}"
      - name: Determine issue number
        id: get_issue_number
        uses: koppor/ticket-check-action@add-output
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ticketLink: 'https://github.com/JabRef/jabref/issues/%ticketNumber%'
          ticketPrefix: '#'
          titleRegex: '^#(?<ticketNumber>\d+)'
          branchRegex: '^(?<ticketNumber>\d+)'
          # Matches GitHub's closes/fixes/resolves #{number}, but does not match our example `Closes #12345` in PULL_REQUEST_TEMPLATE
          bodyRegex: '(?<action>fixes|closes|resolves)\s+#(?<ticketNumber>(?!12345\b)\d+)/i'
          bodyURLRegex: 'http(s?):\/\/(github.com)(\/JabRef)(\/jabref)(\/issues)\/(?<ticketNumber>\d+)'
          outputOnly: true
      - uses: actions/checkout@v4
      - name: Remove assignee
        run: |
          # "brute force" remove assignee - it might happen that the contributor was unassinged, but the PR closed later; therefore we need " || true" to ignore any error
          gh issue edit ${{ steps.get_issue_number.outputs.ticketNumber }} --remove-assignee ${{ github.event.pull_request.user.login }} || true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Check assignees
        id: check_assignee
        run: |
          issue=$(gh issue view ${{ steps.get_issue_number.outputs.ticketNumber }} --json assignees)
          count=$(echo "$issue" | jq '.assignees | length')
          if [ "$count" -gt 0 ]; then
            echo "assigned=yes" >> $GITHUB_OUTPUT
          else
            echo "assigned=no" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Remove labels assigned, reminder-sent, pinned, and "FirstTimeCodeContribution"
        if: steps.check_assignee.outputs.assigned == 'no'
        run: |
          set -e

          gh issue edit ${{ steps.get_issue_number.outputs.ticketNumber }} --remove-label "üìç Assigned"
          gh issue edit ${{ steps.get_issue_number.outputs.ticketNumber }} --remove-label "üîî reminder-sent"
          gh issue edit ${{ steps.get_issue_number.outputs.ticketNumber }} --remove-label "üìå Pinned"
          gh issue edit ${{ steps.get_issue_number.outputs.ticketNumber }} --remove-label "FirstTimeCodeContribution"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Move issue to "Free to take" in "Good First Issues"
        if: steps.check_assignee.outputs.assigned == 'no'
        uses: m7kvqbe1/github-action-move-issues/@add-issue-parameter
        with:
          github-token: ${{ secrets.GH_TOKEN_ACTION_MOVE_ISSUE }}
          project-url: "https://github.com/orgs/JabRef/projects/5"
          target-labels: "üìç Assigned"
          target-column: "Assigned"
          ignored-columns: ""
          default-column: "Free to take"
          issue-number: ${{ steps.get_issue_number.outputs.ticketNumber }}
          skip-if-not-in-project: true
      - name: Move issue to "Free to take" in "Candidates for University Projects"
        if: steps.check_assignee.outputs.assigned == 'no'
        uses: m7kvqbe1/github-action-move-issues/@add-issue-parameter
        with:
          github-token: ${{ secrets.GH_TOKEN_ACTION_MOVE_ISSUE }}
          project-url: "https://github.com/orgs/JabRef/projects/3"
          target-labels: "üìç Assigned"
          target-column: "Assigned"
          ignored-columns: ""
          default-column: "Free to take"
          issue-number: ${{ steps.get_issue_number.outputs.ticketNumber }}
          skip-if-not-in-project: true
  comment_on_resolved_issue:
    name: Comment on resolved issue
    runs-on: ubuntu-latest
    if: github.event.action == 'closed' && github.event.pull_request.merged && github.actor != 'dependabot[bot]' && !startsWith(github.event.pull_request.title, 'New Crowdin updates')
    permissions:
      contents: read
      issues: write
    steps:
      - name: echo PR data
        run: |
          echo "PR Number: ${{ github.event.pull_request.number }}"
          echo "PR URL: ${{ github.event.pull_request.html_url }}"
          echo "PR Body"
          echo "${{ github.event.pull_request.body }}"
      - name: Determine issue number
        id: get_issue_number
        uses: koppor/ticket-check-action@add-output
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ticketLink: 'https://github.com/JabRef/jabref/issues/%ticketNumber%'
          ticketPrefix: '#'
          titleRegex: '^#(?<ticketNumber>\d+)'
          branchRegex: '^(?<ticketNumber>\d+)'
          bodyRegex: '(?<action>fixes|closes|resolves)\s+#(?<ticketNumber>(?!12345\b)\d+)/i'
          bodyURLRegex: 'http(s?):\/\/(github.com)(\/JabRef)(\/jabref)(\/issues)\/(?<ticketNumber>\d+)'
          outputOnly: true
      - name: Comment on issue
        uses: thollander/actions-comment-pull-request@v3
        with:
          pr-number: ${{ steps.get_issue_number.outputs.ticketNumber }}
          message: |
            Closed by ${{ github.event.pull_request.html_url }}

            Please head to <https://builds.jabref.org/main> to try it out.

            For any feedback, add a comment to the pull request at ${{ github.event.pull_request.html_url }}.
