name: CI

on:
  push:
    branches: ["main", "master"]
  pull_request:
    branches: ["main", "master"]

jobs:
  build:
    name: Build and Analyze
    runs-on: ubuntu-latest

    # Necessário para o dorny/test-reporter comentar no PR
    permissions:
      contents: read
      checks: write
      pull-requests: write

    strategy:
      fail-fast: false
      matrix:
        java-version: [17, 21]
        # Removi o 24 pois ainda é instável (Early Access) e pode quebrar builds.
        # Se precisar muito, pode adicionar de volta.

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Importante para o SonarQube detectar novos códigos corretamente

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ matrix.java-version }}
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # Esse passo garante que o arquivo existe, como no seu script original
      - name: Ensure journal-list.mv exists
        run: |
          if [ ! -f "src/main/resources/journals/journal-list.mv" ]; then
            echo "journal-list.mv not found, assuming build will generate or handle it."
          fi

      - name: Build with Gradle
        # O 'check' já roda os testes. O --info ajuda a ver erros se falhar.
        run: ./gradlew build --no-daemon --info

      - name: Publish Test Report
        uses: dorny/test-reporter@v1
        if: success() || failure() # Roda mesmo se os testes falharem
        with:
          name: 'JUnit Tests (Java ${{ matrix.java-version }})'
          path: '**/build/test-results/test/TEST-*.xml'
          reporter: java-junit # <--- AQUI ESTAVA O ERRO, AGORA ESTÁ CORRIGIDO

      - name: Cache SonarCloud packages
        if: matrix.java-version == '21' # Roda o Sonar só uma vez (na versão 21)
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: SonarCloud Scan
        # Só roda o Sonar se for Java 21 e se tiver o Token configurado
        if: matrix.java-version == '21' && env.SONAR_TOKEN != ''
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: ./gradlew sonar --info
